// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Core application models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials auth
  isAdmin       Boolean   @default(false) // Replaces Appwrite "admin" label
  isSuperAdmin  Boolean   @default(false) // System-wide super admin with user management capabilities
  defaultWorkspaceId String?  // Default workspace to route to on login
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // App relations
  ownedWorkspaces Workspace[]    @relation("WorkspaceOwner")
  memberships     Member[]
  createdTasks    Task[]         @relation("TaskCreator")
  taskHistory     TaskHistory[]
  sentMessages    TaskMessage[]
  notifications   Notification[]
  mentionNotifications Notification[] @relation("MentionNotifications")
  defaultWorkspace Workspace? @relation("DefaultWorkspace", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  inviteCode  String   @unique @default(cuid())
  userId      String   // Owner ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner         User           @relation("WorkspaceOwner", fields: [userId], references: [id], onDelete: Cascade)
  members       Member[]
  services      Service[]
  tasks         Task[]
  messages      TaskMessage[]
  notifications Notification[]
  usersWithDefault User[]      @relation("DefaultWorkspace")

  @@index([inviteCode])
  @@index([userId])
  @@index([createdAt])
  @@map("workspaces")
}

enum MemberRole {
  ADMIN
  MEMBER
  VISITOR
}

model Member {
  id          String     @id @default(cuid())
  userId      String
  workspaceId String
  role        MemberRole @default(MEMBER)
  joinedAt    DateTime   @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedTasks Task[] @relation("TaskAssignee")
  reviewingTasks Task[] @relation("TaskReviewer")
  followedTasks Task[] @relation("TaskFollowers")
  taskReviews TaskReview[]
  taskHistory TaskHistory[]
  taskMessages TaskMessage[]

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
  @@index([role])
  @@map("members")
}

model Service {
  id          String   @id @default(cuid())
  name        String
  workspaceId String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([workspaceId])
  @@index([isPublic])
  @@map("services")
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  ARCHIVED
}

model Task {
  id            String     @id @default(cuid())
  taskNumber    String     @unique
  name          String
  description   String?
  status        TaskStatus @default(TODO)
  position      Int        @default(0)
  dueDate       DateTime?
  isConfidential Boolean   @default(false)
  attachmentId  String?
  workspaceId   String
  assigneeId    String?
  reviewerId    String?
  serviceId     String
  creatorId     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  workspace     Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee      Member?          @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reviewer      Member?          @relation("TaskReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)
  service       Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  creator       User?            @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: SetNull)
  followers     Member[]         @relation("TaskFollowers")
  history       TaskHistory[]
  messages      TaskMessage[]
  attachments   TaskAttachment[]
  notifications Notification[]
  reviews       TaskReview[]

  @@index([workspaceId])
  @@index([serviceId])
  @@index([assigneeId])
  @@index([reviewerId])
  @@index([status])
  @@index([createdAt])
  @@index([dueDate])
  @@index([isConfidential])
  @@index([workspaceId, status, createdAt])
  @@map("tasks")
}

enum TaskHistoryAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  ASSIGNEE_CHANGED
  REVIEWER_CHANGED
  SERVICE_CHANGED
  WORKSPACE_CHANGED
  DUE_DATE_CHANGED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  ATTACHMENT_VIEWED
  DESCRIPTION_UPDATED
  NAME_CHANGED
  REVIEW_SUBMITTED
  FOLLOWERS_CHANGED
  CONFIDENTIAL_CHANGED
  ARCHIVED
}

model TaskHistory {
  id        String            @id @default(cuid())
  taskId    String
  userId    String
  memberId  String?
  action    TaskHistoryAction
  field     String?
  oldValue  String?
  newValue  String?
  details   String?
  createdAt DateTime          @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  member Member? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("task_history")
}

model TaskMessage {
  id             String   @id @default(cuid())
  taskId         String
  senderId       String
  senderMemberId String?
  workspaceId    String
  content        String
  attachmentId   String?
  attachmentName String?
  attachmentSize String?
  attachmentType String?
  createdAt      DateTime @default(now())

  // Relations
  task          Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  sender        User           @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderMember  Member?        @relation(fields: [senderMemberId], references: [id], onDelete: SetNull)
  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([taskId])
  @@index([workspaceId])
  @@index([senderId])
  @@index([createdAt])
  @@map("task_messages")
}

model TaskAttachment {
  id          String   @id @default(cuid())
  taskId      String
  fileName    String
  originalName String
  fileSize    Int
  mimeType    String
  filePath    String   // Local file path or cloud URL
  uploadedAt  DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([uploadedAt])
  @@map("task_attachments")
}

enum NotificationType {
  MENTION        // @username mention in chat
  NEW_MESSAGE    // New message in task chat
  TASK_ASSIGNED  // Task assigned to user
  TASK_UPDATE    // Task status/details updated
  TASK_COMMENT   // Comment added to task
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           // Who receives the notification
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)
  workspaceId String
  taskId      String?          // Optional - for task-related notifications
  messageId   String?          // Optional - for message-related notifications
  mentionedBy String?          // Optional - who mentioned the user
  createdAt   DateTime         @default(now())
  readAt      DateTime?

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  task        Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskMessage TaskMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentioner   User?        @relation("MentionNotifications", fields: [mentionedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isRead])
  @@index([workspaceId])
  @@index([createdAt])
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

model TaskReview {
  id          String       @id @default(cuid())
  taskId      String
  reviewerId  String
  status      ReviewStatus @default(PENDING)
  comment     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  task     Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  reviewer Member @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([reviewerId])
  @@index([status])
  @@index([createdAt])
  @@map("task_reviews")
}